# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1

x-filter-all-branches-and-tags: &all-branches-and-tags
  branches:
    only: /.*/
  tags:
    only: /.*/

x-filter-develop-only: &develop-only
  branches:
    only: develop

x-filter-master-only: &master-only
  branches:
    only: master

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  build-libs:
    docker:
      - image: circleci/node:16
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies1-{{ checksum "package.json" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies1-
      - run: yarn install
      - run: yarn lint-libs
      - run: yarn build-lib-iframe # Build the iframe library.
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies1-{{ checksum "package.json" }}
      - persist_to_workspace:
          root: .
          paths:
            - build/libs
  unit-test-libs:
    resource_class: large
    docker:
      - image: circleci/node:16
        environment:
          NODE_OPTIONS: --max_old_space_size=8192
    working_directory: ~/project
    steps:
      - checkout
      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies1-{{ checksum "package.json" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies1-
      - run: yarn test-libs
  build-demo:
    docker:
      - image: circleci/node:16
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies1-{{ checksum "package.json" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies1-
      - run: yarn install
      - run: yarn build-demo # Build the demo site.
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies1-{{ checksum "package.json" }}
      - persist_to_workspace:
          root: .
          paths:
            - build/demo
  deploy-demo:
    parameters:
      domain:
        type: string
      bucket:
        type: string
    docker:
      - image: google/cloud-sdk:282.0.0-alpine
    steps:
      - run: apk add --no-cache git make openssh
      - checkout
      - run: gcloud auth activate-service-account --key-file=<(echo "$GOOGLE_SERVICE_ACCOUNT_KEY")
      - attach_workspace:
          at: .
      - run: gsutil -m rsync -r build/demo/tomito/ "gs://<< parameters.bucket >>"

# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  default:
    jobs:
      - build-libs:
          filters: *all-branches-and-tags
      - unit-test-libs:
          filters: *all-branches-and-tags
          requires:
            - build-libs
      - build-demo:
          filters: *all-branches-and-tags
      - deploy-demo:
          name: deploy-gcp-demo-qa
          domain: protect-lite.qa.bestowlabs.com
          bucket: protect-lite.qa.bestowlabs.com
          context: gcp-policy-platform-qa
          requires:
            - build-demo
          filters: *develop-only
      - deploy-demo:
          name: deploy-gcp-demo-prod
          domain: protect-lite.bestowlabs.com
          bucket: protect-lite.bestowlabs.com
          context: gcp-policy-platform-qa
          requires:
            - build-demo
          filters: *master-only
